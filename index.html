<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rummikub Turn Timer</title>

<!-- Roboto Mono（等幅） -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    /* Dark / High-contrast base */
    --bg:#121212;
    --panel:#171a1f;
    --line:#2a2f36;
    --text:#ffffff;
    --muted:#b7c0cc;

    /* Dynamic (player theme) */
    --theme:#4f6d8a;
    --themeSoft: rgba(79,109,138,.22);

    /* Accent */
    --accent:#2a63ff;
    --danger:#ff3b3b;

    /* Typography */
    --mono: "Roboto Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }

  body{
    margin:0;
    background: var(--bg);
    color: var(--text);
  }

  /* ===== PLAY (full screen) ===== */
  #play{
    position: fixed;
    inset: 0;
    background:
      radial-gradient(1200px 700px at 50% 40%, rgba(255,255,255,.04), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.03), transparent 25%),
      var(--bg);
    border: 10px solid rgba(255,255,255,.06);
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.02);
    transition: border-color .15s ease, box-shadow .15s ease, background .2s ease;
  }

  /* Player theme glow */
  #play.theming{
    border-color: color-mix(in srgb, var(--theme) 70%, rgba(255,255,255,.08));
    box-shadow:
      inset 0 0 0 2px rgba(255,255,255,.03),
      0 0 0 1px rgba(255,255,255,.03),
      0 0 26px rgba(0,0,0,.45),
      0 0 44px var(--themeSoft);
  }

  /* Progress bar */
  #progressOuter{
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 10px;
    background: rgba(255,255,255,.06);
    overflow: hidden;
  }
  #progressFill{
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, rgba(255,255,255,.15), rgba(255,255,255,.05));
    position: relative;
  }
  #progressFill::after{
    content:"";
    position:absolute;
    inset:0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
    transform: translateX(-60%);
    animation: sheen 2.2s infinite;
    opacity: .55;
  }
  @keyframes sheen{
    0% { transform: translateX(-60%); }
    100% { transform: translateX(160%); }
  }

  /* Center tap area */
  #centerTap{
    position: absolute;
    inset: 0;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    text-align:center;
    user-select:none;
    touch-action: manipulation;
  }

  /* Time (huge + mono) */
  #time{
    font-family: var(--mono);
    font-weight: 700;
    font-size: min(22vw, 160px);
    letter-spacing: 1px;
    line-height: 1;
    margin: 6px 0 0;
    text-shadow: 0 10px 26px rgba(0,0,0,.55);
  }

  /* Who */
  #who{
    margin-top: 14px;
    font-family: var(--mono);
    font-weight: 600;
    font-size: min(6vw, 34px);
    color: rgba(255,255,255,.9);
    opacity: .95;
  }

  /* Hint */
  #hint{
    margin-top: 14px;
    font-size: 14px;
    color: var(--muted);
    opacity: .9;
    line-height: 1.35;
  }

  /* 10-sec warning: heart-beat pulse + red tint */
  .warning #time{
    color: #ff4d4d;
    animation: pulse .75s infinite;
  }
  .warning #play{
    background:
      radial-gradient(900px 600px at 50% 40%, rgba(255,77,77,.10), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.03), transparent 25%),
      var(--bg);
  }
  @keyframes pulse{
    0%{ transform: scale(1); }
    50%{ transform: scale(1.055); }
    100%{ transform: scale(1); }
  }

  /* Timeout flash */
  .timeoutFlash #play{
    box-shadow:
      inset 0 0 0 2px rgba(255,255,255,.03),
      0 0 0 1px rgba(255,255,255,.03),
      0 0 60px rgba(255,77,77,.22);
  }

  /* Ripple */
  .ripple{
    position:absolute;
    border-radius: 9999px;
    background: rgba(255,255,255,.14);
    transform: scale(0);
    animation: ripple .55s ease-out;
    pointer-events:none;
  }
  @keyframes ripple{
    to { transform: scale(1); opacity: 0; }
  }

  /* ===== SETTINGS MODAL ===== */
  #settingsBackdrop{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.66);
    backdrop-filter: blur(8px);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
    z-index: 50;
  }
  #settingsBackdrop.open{ display:flex; }

  #settingsModal{
    width: min(780px, 100%);
    background: var(--panel);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 18px;
    box-shadow: 0 20px 60px rgba(0,0,0,.55);
    overflow: hidden;
  }

  #settingsHeader{
    padding: 18px 18px 10px;
    border-bottom: 1px solid rgba(255,255,255,.08);
  }
  #settingsHeader h2{
    margin: 0;
    font-size: 22px;
    letter-spacing: .2px;
  }
  #settingsHeader p{
    margin: 8px 0 0;
    color: var(--muted);
    font-size: 13px;
  }

  #settingsBody{
    padding: 16px 18px 120px; /* footer space */
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
  }
  @media (max-width: 560px){
    .grid{ grid-template-columns: 1fr; }
  }

  .field label{
    display:block;
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 6px;
  }
  .field input, .field select{
    width:100%;
    height: 48px;             /* >=44px */
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.25);
    color: var(--text);
    outline: none;
  }
  .field input:focus, .field select:focus{
    border-color: color-mix(in srgb, var(--accent) 70%, rgba(255,255,255,.14));
    box-shadow: 0 0 0 3px rgba(42,99,255,.22);
  }

  .playersGrid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
    margin-top: 14px;
  }
  @media (max-width: 560px){
    .playersGrid{ grid-template-columns: 1fr; }
  }

  .playerWrap{ display:block; }
  .playerWrap.hidden{ display:none; }

  /* Footer: Start fixed large */
  #settingsFooter{
    position: absolute;
    left: 0; right: 0; bottom: 0;
    padding: 14px 18px;
    background: linear-gradient(180deg, rgba(23,26,31,0), rgba(23,26,31,1) 45%);
    border-top: 1px solid rgba(255,255,255,.08);
    display:flex;
    gap: 12px;
    align-items:center;
  }

  .btn{
    height: 54px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.22);
    color: var(--text);
    font-weight: 700;
    font-size: 16px;
    padding: 0 14px;
  }
  .btnPrimary{
    flex: 1;
    background: linear-gradient(180deg, rgba(42,99,255,.95), rgba(42,99,255,.75));
    border-color: rgba(42,99,255,.7);
    box-shadow: 0 10px 26px rgba(42,99,255,.16);
  }
  .btnSecondary{
    width: 120px;
    color: rgba(255,255,255,.92);
    background: rgba(255,255,255,.04);
  }
  .btnSecondary:hover{ background: rgba(255,255,255,.06); }

  /* Reset toned down (still dangerous) */
  .btnDanger{
    width: 120px;
    background: rgba(255,77,77,.12);
    border-color: rgba(255,77,77,.22);
    color: rgba(255,255,255,.95);
  }

  /* Small top-right hint in play */
  #playBadge{
    position:absolute;
    top: 14px;
    right: 14px;
    font-family: var(--mono);
    font-size: 12px;
    color: rgba(255,255,255,.72);
    background: rgba(0,0,0,.28);
    border: 1px solid rgba(255,255,255,.10);
    padding: 8px 10px;
    border-radius: 999px;
    backdrop-filter: blur(6px);
  }
</style>
</head>

<body>
  <!-- PLAY -->
  <div id="play" class="theming">
    <div id="progressOuter"><div id="progressFill"></div></div>
    <div id="playBadge">Tap: Next  |  Hold 5s: Settings</div>

    <div id="centerTap">
      <div id="time">0:00</div>
      <div id="who">-</div>
      <div id="hint">どこでもタップで次へ / 5秒長押しで設定</div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settingsBackdrop" class="open" aria-hidden="false">
    <div id="settingsModal" role="dialog" aria-modal="true">
      <div id="settingsHeader">
        <h2>設定</h2>
        <p>人数と制限時間をセットして「開始」。プレイ中は全画面タップで進行します。</p>
      </div>

      <div id="settingsBody">
        <div class="grid">
          <div class="field">
            <label for="count">参加人数（2〜5）</label>
            <select id="count">
              <option>2</option>
              <option selected>3</option>
              <option>4</option>
              <option>5</option>
            </select>
          </div>
          <div class="field">
            <label for="limit">制限時間（秒）</label>
            <input id="limit" type="number" min="5" step="5" value="60">
          </div>
        </div>

        <div class="playersGrid" id="playersGrid">
          <div class="field playerWrap" data-player="1">
            <label>プレイヤー1</label>
            <input class="pname" value="P1" inputmode="text" />
          </div>
          <div class="field playerWrap" data-player="2">
            <label>プレイヤー2</label>
            <input class="pname" value="P2" inputmode="text" />
          </div>
          <div class="field playerWrap" data-player="3">
            <label>プレイヤー3</label>
            <input class="pname" value="P3" inputmode="text" />
          </div>
          <div class="field playerWrap" data-player="4">
            <label>プレイヤー4</label>
            <input class="pname" value="P4" inputmode="text" />
          </div>
          <div class="field playerWrap" data-player="5">
            <label>プレイヤー5</label>
            <input class="pname" value="P5" inputmode="text" />
          </div>
        </div>
      </div>

      <div id="settingsFooter">
        <button id="reset" class="btn btnDanger" type="button">リセット</button>
        <button id="close" class="btn btnSecondary" type="button">閉じる</button>
        <button id="start" class="btn btnPrimary" type="button">開始</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // Elements
  const play = $("play");
  const centerTap = $("centerTap");
  const timeEl = $("time");
  const whoEl = $("who");
  const hintEl = $("hint");
  const progressFill = $("progressFill");

  const settingsBackdrop = $("settingsBackdrop");
  const countEl = $("count");
  const limitEl = $("limit");
  const startBtn = $("start");
  const resetBtn = $("reset");
  const closeBtn = $("close");
  const playerWraps = [...document.querySelectorAll(".playerWrap")];
  const nameInputs = [...document.querySelectorAll(".pname")];

  // Theme colors per player (can tweak)
  const THEME = ["#ff4d4d", "#2a63ff", "#ffd24d", "#57d6a3", "#b070ff"];

  // State
  let players = [];
  let limitSec = 60;
  let idx = 0;
  let remaining = 0;
  let timer = null;
  let playing = false;
  let timedOut = false;

  // Long press
  const HOLD_MS = 5000;
  let holdTimer = null;
  let holdFired = false;

  // -------- Utils
  function format(sec){
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return `${m}:${String(s).padStart(2,"0")}`;
  }

  function setTheme(){
    const c = THEME[idx % THEME.length];
    document.documentElement.style.setProperty("--theme", c);
    document.documentElement.style.setProperty("--themeSoft", hexToRgba(c, .22));
    // progress bar uses theme
    progressFill.style.background = `linear-gradient(90deg, ${hexToRgba(c,.90)}, ${hexToRgba(c,.35)})`;
    play.classList.add("theming");
  }

  function hexToRgba(hex, a){
    const h = hex.replace("#","");
    const r = parseInt(h.substring(0,2),16);
    const g = parseInt(h.substring(2,4),16);
    const b = parseInt(h.substring(4,6),16);
    return `rgba(${r},${g},${b},${a})`;
  }

  // -------- Sounds (WebAudio)
  function tone(ms, freq, type="square", gain=0.04){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = type;
      o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(() => { o.stop(); ctx.close(); }, ms);
    }catch(_){}
  }

  function clickSound(){ tone(80, 1100, "square", 0.035); }        // "カチッ"
  function warnTick(){ tone(45, 1400, "square", 0.03); }           // 10秒煽り
  function alarmSound(){
    tone(220, 520, "sawtooth", 0.04);
    setTimeout(() => tone(220, 420, "sawtooth", 0.04), 260);
  }

  // -------- Modal control
  function openSettings(){
    playing = false;
    stopTimer();
    setWarning(false);
    settingsBackdrop.classList.add("open");
    settingsBackdrop.setAttribute("aria-hidden","false");
    hintEl.textContent = "どこでもタップで次へ / 5秒長押しで設定";
  }

  function closeSettings(){
    settingsBackdrop.classList.remove("open");
    settingsBackdrop.setAttribute("aria-hidden","true");
  }

  // -------- Conditional display of players
  function applyPlayerVisibility(){
    const n = Number(countEl.value);
    playerWraps.forEach(w => {
      const p = Number(w.dataset.player);
      w.classList.toggle("hidden", p > n);
    });
  }

  // -------- Timer control
  function startTurn(){
    remaining = limitSec;
    timedOut = false;
    setWarning(false);
    updateUI();
    stopTimer();
    timer = setInterval(tick, 1000);
  }

  function stopTimer(){
    if(timer) clearInterval(timer);
    timer = null;
  }

  function tick(){
    if(!playing) return;

    // 10秒煽り（音＋見た目）
    if(remaining <= 10 && remaining > 0){
      warnTick();
      setWarning(true);
    }else{
      setWarning(false);
    }

    remaining = Math.max(0, remaining - 1);
    updateUI();

    if(remaining === 0){
      // time up: stop but allow next
      stopTimer();
      timedOut = true;
      alarmSound();
      flashTimeout();
      hintEl.textContent = "時間切れ！タップで次へ（続行） / 5秒長押しで設定";
    }
  }

  function updateUI(){
    timeEl.textContent = format(remaining);
    whoEl.textContent = `${players[idx] ?? "-"} の番`;
    setTheme();

    const pct = limitSec > 0 ? (remaining / limitSec) * 100 : 0;
    progressFill.style.width = `${pct}%`;
  }

  function setWarning(on){
    document.body.classList.toggle("warning", on);
  }

  function flashTimeout(){
    document.body.classList.add("timeoutFlash");
    setTimeout(() => document.body.classList.remove("timeoutFlash"), 400);
  }

  function nextPlayer(){
    if(!playing) return;

    // allow advancing even if timed out
    idx = (idx + 1) % players.length;
    clickSound();
    startTurn();
    hintEl.textContent = "どこでもタップで次へ / 5秒長押しで設定";
  }

  // -------- Ripple
  function rippleAt(x, y){
    const r = document.createElement("div");
    r.className = "ripple";
    const rect = play.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height) * 1.2;
    r.style.width = r.style.height = `${size}px`;
    r.style.left = `${x - rect.left - size/2}px`;
    r.style.top  = `${y - rect.top  - size/2}px`;
    play.appendChild(r);
    r.addEventListener("animationend", () => r.remove());
  }

  // -------- Events
  countEl.addEventListener("change", applyPlayerVisibility);

  startBtn.addEventListener("click", () => {
    // gather visible players only
    const n = Number(countEl.value);
    players = nameInputs.slice(0, n).map((inp, i) => (inp.value || `P${i+1}`).trim());
    limitSec = Math.max(5, Number(limitEl.value || 60));
    idx = 0;

    playing = true;
    closeSettings();
    startTurn();
  });

  resetBtn.addEventListener("click", () => {
    // soft reset for settings only
    countEl.value = "3";
    limitEl.value = "60";
    nameInputs.forEach((inp, i) => inp.value = `P${i+1}`);
    applyPlayerVisibility();
    tone(80, 780, "square", 0.03);
  });

  closeBtn.addEventListener("click", () => {
    // only closes if already playing; otherwise stay
    if(playing) closeSettings();
    else tone(60, 420, "square", 0.03);
  });

  // Full screen tap: next (with ripple)
  centerTap.addEventListener("pointerdown", (e) => {
    if(!playing) return;

    holdFired = false;
    const { clientX, clientY } = e;
    rippleAt(clientX, clientY);

    // long press -> settings
    holdTimer = setTimeout(() => {
      holdFired = true;
      openSettings();
      // little acknowledgement
      tone(120, 520, "square", 0.03);
    }, HOLD_MS);
  });

  ["pointerup","pointercancel","pointerleave"].forEach(ev => {
    centerTap.addEventListener(ev, () => {
      if(holdTimer) clearTimeout(holdTimer);
      holdTimer = null;
    });
  });

  centerTap.addEventListener("click", (e) => {
    if(!playing) return;
    // If long press already fired, ignore click
    if(holdFired) return;
    nextPlayer();
  });

  // Init
  applyPlayerVisibility();
  openSettings(); // start in settings
  // Set a default UI (hidden behind modal)
  players = ["P1","P2","P3"];
  limitSec = 60;
  idx = 0;
  remaining = 60;
  updateUI();
})();
</script>
</body>
</html>
