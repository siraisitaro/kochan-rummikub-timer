<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rummikub Turn Timer</title>

<style>
:root{
  --bg:#0b0f14;
  --card:#121a24;
  --line:#1f2a3a;
  --accent:#2a63ff;
  --danger:#ff3b3b;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
}

body{
  margin:0;
  background:var(--bg);
  color:#e8eef6;
}

.hidden{ display:none; }

.wrap{
  max-width:720px;
  margin:0 auto;
  padding:16px;
}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  padding:16px;
}

label{
  font-size:12px;
  color:#aab6c6;
  display:block;
  margin-bottom:6px;
}

input,select{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #263244;
  background:#0e1520;
  color:#e8eef6;
}

.row{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

.col{ flex:1 1 160px; }

button{
  padding:14px;
  border-radius:14px;
  border:1px solid #2a3950;
  background:#162234;
  color:#e8eef6;
  font-weight:700;
  font-size:16px;
}

.primary{
  background:var(--accent);
  border-color:var(--accent);
}

.danger{
  background:var(--danger);
  border-color:var(--danger);
  color:#fff;
}

/* ===== プレイ画面 ===== */

#centerTap{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  user-select:none;
}

#time{
  font-size:130px;
  font-weight:900;
  line-height:1;
}

#who{
  font-size:28px;
  margin-top:12px;
  color:#cfe0ff;
}

#hint{
  margin-top:12px;
  color:#aab6c6;
  font-size:14px;
}

</style>
</head>

<body>
<div class="wrap">

<!-- ===== 設定画面 ===== -->
<div id="settings" class="card">
  <h2>設定</h2>

  <div class="row">
    <div class="col">
      <label>参加人数</label>
      <select id="count">
        <option>2</option>
        <option selected>3</option>
        <option>4</option>
        <option>5</option>
      </select>
    </div>
    <div class="col">
      <label>制限時間（秒）</label>
      <input id="limit" type="number" value="60" min="5" step="5">
    </div>
  </div>

  <div class="row" style="margin-top:12px;">
    <div class="col"><input class="pname" value="P1"></div>
    <div class="col"><input class="pname" value="P2"></div>
    <div class="col"><input class="pname" value="P3"></div>
    <div class="col"><input class="pname" value="P4"></div>
    <div class="col"><input class="pname" value="P5"></div>
  </div>

  <div class="row" style="margin-top:16px;">
    <div class="col">
      <button id="start" class="primary">開始</button>
    </div>
    <div class="col">
      <button id="reset" class="danger">リセット</button>
    </div>
  </div>
</div>

</div>

<!-- ===== プレイ画面 ===== -->
<div id="play" class="hidden">
  <div id="centerTap">
    <div id="time">0:00</div>
    <div id="who"></div>
    <div id="hint">
      タップ：次へ<br>
      5秒長押しで設定へ
    </div>
  </div>
</div>

<script>
(() => {
  const $ = id => document.getElementById(id);

  const settings = $("settings");
  const play = $("play");
  const centerTap = $("centerTap");
  const timeEl = $("time");
  const whoEl = $("who");

  const countEl = $("count");
  const limitEl = $("limit");
  const startBtn = $("start");
  const resetBtn = $("reset");
  const nameInputs = [...document.querySelectorAll(".pname")];

  let players = [];
  let limit = 60;
  let idx = 0;
  let remain = 0;
  let timer = null;
  let playing = false;
  let holdTimer = null;

  function format(sec){
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${m}:${String(s).padStart(2,"0")}`;
  }

  function tick(){
    remain--;
    if(remain<=0){
      remain = 0;
      beep();
      stop();
    }
    update();
  }

  function startTurn(){
    remain = limit;
    update();
    stop();
    timer = setInterval(tick,1000);
  }

  function stop(){
    if(timer) clearInterval(timer);
    timer = null;
  }

  function next(){
    if(!playing) return;
    idx = (idx+1)%players.length;
    startTurn();
  }

  function update(){
    if(!playing) return;
    timeEl.textContent = format(remain);
    whoEl.textContent = players[idx]+" の番";
  }

  function showPlay(){
    playing = true;
    settings.classList.add("hidden");
    play.classList.remove("hidden");
    idx = 0;
    startTurn();
  }

  function showSettings(){
    playing = false;
    stop();
    play.classList.add("hidden");
    settings.classList.remove("hidden");
  }

  function beep(){
    try{
      const ctx = new AudioContext();
      const o = ctx.createOscillator();
      o.frequency.value = 880;
      o.connect(ctx.destination);
      o.start();
      setTimeout(()=>{o.stop();ctx.close();},150);
    }catch(e){}
  }

  startBtn.onclick = () => {
    players = nameInputs
      .slice(0,+countEl.value)
      .map((n,i)=>n.value||"P"+(i+1));
    limit = +limitEl.value || 60;
    showPlay();
  };

  resetBtn.onclick = () => {
    nameInputs.forEach((n,i)=>n.value="P"+(i+1));
    countEl.value = 3;
    limitEl.value = 60;
  };

  centerTap.addEventListener("click",()=>{
    if(!playing) return;
    next();
  });

  centerTap.addEventListener("pointerdown",()=>{
    if(!playing) return;
    holdTimer = setTimeout(showSettings,5000);
  });

  centerTap.addEventListener("pointerup",()=>{
    clearTimeout(holdTimer);
  });

})();
</script>
</body>
</html>
