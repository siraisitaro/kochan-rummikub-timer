<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Rumi-TIMER!</title>
<meta name="theme-color" content="#121212">
<meta name="description" content="„É©„Éü„Éº„Ç≠„É•„Éº„ÉñÂ∞ÇÁî®„ÅÆÈ´òÊ©üËÉΩ„Çø„Éº„É≥„Çø„Ç§„Éû„Éº">

<!-- PWAË®≠ÂÆö -->
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon.png">
<!-- iOSÁî®„Éï„É´„Çπ„ÇØ„É™„Éº„É≥Ë®≠ÂÆö -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700;900&family=Roboto+Mono:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#121212;
    --panel:#171a1f;
    --text:#ffffff;
    --muted:#b7c0cc;
    --theme:#4f6d8a;
    --accent:#2a63ff;
    --danger:#ff3b3b;
    --mono: "Roboto Mono", monospace;
    --sans: "Noto Sans JP", system-ui, -apple-system, sans-serif;
  }

  body {
    margin: 0; background: var(--bg); color: var(--text);
    font-family: var(--sans); overflow: hidden;
    touch-action: manipulation; -webkit-tap-highlight-color: transparent;
    user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;
  }
  input, select { user-select: auto; -webkit-user-select: auto; font-family: var(--sans); }

  /* ===== ICONS (SVG) ===== */
  .icon { width: 28px; height: 28px; fill: currentColor; }

  /* ===== HOME ===== */
  #home{
    position: fixed; inset: 0;
    display:flex; flex-direction:column; align-items:center; justify-content:flex-end;
    padding-bottom: max(env(safe-area-inset-bottom), 80px);
    z-index: 60; background: #1a2a6c; transition: opacity 0.3s;
  }
  .home-bg{
    position: fixed; inset: 0; background: url("home-bg.png") center bottom / cover no-repeat; z-index: -1;
  }
  .homeCard{ width: 100%; display: flex; justify-content: center; }
  
  .homeBtnPrimary{
    background: linear-gradient(180deg, #ff4d4d, #c41e1e);
    border: 3px solid #fff; border-radius: 50px;
    padding: 0 40px; height: 64px;
    font-size: 20px; font-weight: 800; letter-spacing: 1px; color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    animation: float 2s infinite ease-in-out;
    cursor: pointer; will-change: transform;
    transition: transform 0.1s, filter 0.1s;
    font-family: var(--sans);
  }
  .homeBtnPrimary:active { transform: scale(0.92); filter: brightness(0.9); }
  @keyframes float { 0% { transform: translateY(0); } 50% { transform: translateY(-6px); } 100% { transform: translateY(0); } }

  #langSwitch {
    position: absolute; top: max(env(safe-area-inset-top), 20px); right: 20px;
    background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.3);
    color: white; padding: 8px 16px; border-radius: 20px;
    font-family: var(--mono); font-size: 14px; cursor: pointer;
    backdrop-filter: blur(4px); transition: transform 0.1s;
  }
  #langSwitch:active { transform: scale(0.95); }
  #home.hidden{ opacity: 0; pointer-events: none; }

  /* ===== PLAY ===== */
  #play{
    position: fixed; inset: 0;
    background: radial-gradient(circle at 50% 40%, rgba(255,255,255,.04), transparent 60%), var(--bg);
    border: 8px solid rgba(255,255,255,.06);
    transition: border-color 0.2s, transform 0.1s;
    transform-origin: center;
  }
  #play.active-press { transform: scale(0.97); border-color: rgba(255,255,255,0.15); }
  #play.theming{ border-color: color-mix(in srgb, var(--theme) 70%, rgba(255,255,255,.1)); }

  #progressOuter{ position: absolute; top: 0; left: 0; right: 0; height: 10px; background: rgba(255,255,255,.06); overflow: hidden; }
  #progressFill{ height: 100%; width: 0%; background: #fff; transition: width 0.2s linear; }

  #topControls {
    position: absolute; 
    top: max(env(safe-area-inset-top), 24px);
    left: 0; right: 0;
    display: flex; justify-content: space-between; 
    padding: 0 24px;
    pointer-events: none;
    z-index: 10;
  }
  .controlBtn {
    pointer-events: auto;
    width: 54px; height: 54px;
    border-radius: 50%;
    background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.2);
    color: white;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    cursor: pointer;
    transition: transform 0.1s, background 0.1s, border-color 0.1s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  }
  .controlBtn:active { transform: scale(0.85); background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.5); }

  #centerTap{
    position: absolute; inset: 0;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    text-align:center; -webkit-touch-callout: none;
  }

  #time{
    font-family: var(--mono); font-weight: 700;
    font-size: min(24vw, 180px); line-height: 1; margin-top:10px;
    text-shadow: 0 10px 40px rgba(0,0,0,.6); font-variant-numeric: tabular-nums;
  }
  #playerName{
    margin-top: 10px; font-family: var(--mono); font-weight: 700;
    font-size: min(10vw, 50px); text-shadow: 0 2px 10px rgba(0,0,0,.5);
  }
  #hint{
    position: absolute; bottom: max(env(safe-area-inset-bottom), 30px);
    font-size: 13px; color: var(--muted); opacity: .7;
    pointer-events: none; width: 90%; letter-spacing: 0.5px;
  }

  .warning #time{ color: #ff4d4d; animation: pulse .75s infinite; }
  @keyframes pulse{ 50%{ transform: scale(1.05); } }
  .timeoutFlash #play{ box-shadow: inset 0 0 0 2px rgba(255,255,255,.1), 0 0 60px rgba(255,77,77,.4); background-color: rgba(255,0,0,0.15); }
  
  .ripple{
    position:absolute; border-radius: 50%; background: rgba(255,255,255,.12);
    transform: scale(0); animation: ripple .4s ease-out; pointer-events:none;
  }
  @keyframes ripple{ to { transform: scale(1.8); opacity: 0; } }

  /* ===== PAUSE OVERLAY ===== */
  #pauseOverlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.65);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    z-index: 50; display: none; flex-direction: column; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.2s;
  }
  #pauseOverlay.open { display: flex; opacity: 1; }
  
  .pauseTitle { 
    font-size: 32px; font-weight: 900; margin-bottom: 40px; 
    letter-spacing: 4px; color: #fff; text-shadow: 0 4px 15px rgba(0,0,0,0.5);
  }
  
  /* „Éú„Çø„É≥„ÇíÂ§ß„Åç„Åè„ÄÅÈñìÈöî„ÇíÂ∫É„Åè */
  .pauseMenu { 
    display: flex; flex-direction: column; gap: 20px; 
    width: min(320px, 85%); 
  }
  
  #pauseOverlay .btn {
    height: 68px; /* ÈÄöÂ∏∏„Çà„ÇäÈ´ò„Åè */
    font-size: 18px;
    letter-spacing: 1px;
    border-radius: 18px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  }

  /* ===== SETTINGS ===== */
  #settingsBackdrop{
    position: fixed; inset: 0; background: rgba(0,0,0,.85);
    backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center;
    padding: 16px; z-index: 100; opacity: 0; transition: opacity 0.25s;
  }
  #settingsBackdrop.open{ display:flex; opacity: 1; }
  #settingsModal{
    width: min(600px, 100%); background: var(--panel);
    border: 1px solid rgba(255,255,255,.15); border-radius: 24px;
    display: flex; flex-direction: column; max-height: 85vh;
    box-shadow: 0 20px 60px rgba(0,0,0,.7);
    transform: translateY(30px) scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }
  #settingsBackdrop.open #settingsModal { transform: translateY(0) scale(1); }
  #settingsBody{ padding: 20px; overflow-y: auto; }
  
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .playersGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
  label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; font-weight: 700;}
  input, select{
    width:100%; height: 50px; padding: 0 16px; border-radius: 12px;
    border: 1px solid rgba(255,255,255,.15); background: rgba(0,0,0,.3); color: white;
    font-size: 16px; outline: none; box-sizing: border-box;
  }
  .playerWrap.hidden{ display:none; }
  #settingsFooter{
    padding: 16px 20px; background: rgba(20,20,25,.95);
    border-top: 1px solid rgba(255,255,255,.1); display:flex; gap: 10px;
    padding-bottom: max(env(safe-area-inset-bottom), 16px);
  }
  
  .btn{
    flex:1; height: 54px; border-radius: 14px; border:none;
    font-weight:700; font-size:16px; cursor:pointer; color: white;
    transition: transform 0.1s, filter 0.1s; font-family: var(--sans);
    display: flex; align-items: center; justify-content: center;
  }
  .btn:active { transform: scale(0.96); filter: brightness(0.9); }
  .btnPrimary{ background: #2a63ff; box-shadow: 0 4px 12px rgba(42,99,255,0.3); }
  .btnSecondary{ background: rgba(255,255,255,.1); }
  .btnDanger{ background: rgba(255,77,77,.15); color: #ff6666; }
  
  .btnWin { background: linear-gradient(135deg, #ffd700, #ffa500); color: #000; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); font-weight: 900 !important; }

  /* CONFETTI CANVAS */
  #confettiCanvas { position: fixed; inset: 0; pointer-events: none; z-index: 200; }
</style>
</head>

<body>
  <!-- HOME -->
  <div id="home">
    <div class="home-bg"></div>
    <button id="langSwitch">üáØüáµ Êó•Êú¨Ë™û</button>
    <div class="homeCard">
      <button id="goTimer" class="homeBtnPrimary">„Ç≤„Éº„É†ÈñãÂßã</button>
    </div>
  </div>

  <!-- PLAY -->
  <div id="play" class="theming">
    <div id="progressOuter"><div id="progressFill"></div></div>
    
    <!-- TOP ICONS -->
    <div id="topControls">
      <button id="btnPause" class="controlBtn" aria-label="Pause">
        <svg class="icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
      </button>
      <button id="btnMute" class="controlBtn" aria-label="Mute">
        <svg class="icon" id="iconSound" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
      </button>
    </div>

    <div id="centerTap">
      <div id="time">0:00</div>
      <div id="playerName">-</div>
      <div id="hint">„Çø„ÉÉ„Éó: Ê¨°„Å∏ / 3Âõû: Êàª„Çã / Èï∑Êäº„Åó: Ë®≠ÂÆö</div>
    </div>
  </div>

  <!-- PAUSE OVERLAY -->
  <div id="pauseOverlay">
    <div id="pauseTitle" class="pauseTitle">PAUSED</div>
    <div class="pauseMenu">
      <button id="btnResume" class="btn btnPrimary">ÂÜçÈñã</button>
      <button id="btnWin" class="btn btnWin">üèÜ „Ç≤„Éº„É†ÁµÇ‰∫Ü (ÂãùÂà©)</button>
      <button id="btnQuit" class="btn btnSecondary">„Éõ„Éº„É†„Å∏Êàª„Çã</button>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="settingsBackdrop">
    <div id="settingsModal">
      <div style="padding: 20px 20px 0;"><h2 id="lblSettingsTitle">Ë®≠ÂÆö</h2></div>
      <div id="settingsBody">
        <div class="grid">
          <div><label id="lblCount">ÂèÇÂä†‰∫∫Êï∞</label><select id="count"><option>2</option><option selected>3</option><option>4</option><option>5</option></select></div>
          <div><label id="lblLimit">Âà∂ÈôêÊôÇÈñìÔºàÁßíÔºâ</label><input id="limit" type="number" value="60"></div>
        </div>
        <div class="playersGrid" id="playersGrid">
          <div class="playerWrap" data-p="1"><label id="lblP1">„Éó„É¨„Ç§„É§„Éº1</label><input class="pname" id="p1" value="P1"></div>
          <div class="playerWrap" data-p="2"><label id="lblP2">„Éó„É¨„Ç§„É§„Éº2</label><input class="pname" id="p2" value="P2"></div>
          <div class="playerWrap" data-p="3"><label id="lblP3">„Éó„É¨„Ç§„É§„Éº3</label><input class="pname" id="p3" value="P3"></div>
          <div class="playerWrap" data-p="4"><label id="lblP4">„Éó„É¨„Ç§„É§„Éº4</label><input class="pname" id="p4" value="P4"></div>
          <div class="playerWrap" data-p="5"><label id="lblP5">„Éó„É¨„Ç§„É§„Éº5</label><input class="pname" id="p5" value="P5"></div>
        </div>
      </div>
      <div id="settingsFooter">
        <button id="reset" class="btn btnDanger">„É™„Çª„ÉÉ„Éà</button>
        <button id="close" class="btn btnSecondary">Êàª„Çã</button>
        <button id="start" class="btn btnPrimary">„Çπ„Çø„Éº„Éà</button>
      </div>
    </div>
  </div>

  <canvas id="confettiCanvas"></canvas>

<script>
(() => {
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});

  const $ = (id) => document.getElementById(id);
  const play = $("play");
  const timeEl = $("time");
  const nameEl = $("playerName");
  const progressFill = $("progressFill");
  const langBtn = $("langSwitch");
  const iconSound = $("iconSound");
  
  const pauseOverlay = $("pauseOverlay");
  const btnPause = $("btnPause");
  const btnResume = $("btnResume");
  const btnQuit = $("btnQuit");
  const btnWin = $("btnWin");

  const THEME = ["#ff4d4d", "#2a63ff", "#ffd24d", "#57d6a3", "#b070ff"];
  
  let players = [];
  let limit = 60;
  let idx = 0;
  let remaining = 0;
  let timer = null;
  let playing = false;
  let paused = false;
  let currentLang = "jp";
  let muted = false;

  const TRANS = {
    jp: {
      langLabel: "üáØüáµ Êó•Êú¨Ë™û", goTimer: "„Ç≤„Éº„É†ÈñãÂßã", hint: "„Çø„ÉÉ„Éó: Ê¨°„Å∏ / 3Âõû: Êàª„Çã / Èï∑Êäº„Åó: Ë®≠ÂÆö",
      lblSettingsTitle: "Ë®≠ÂÆö", lblCount: "ÂèÇÂä†‰∫∫Êï∞", lblLimit: "Âà∂ÈôêÊôÇÈñìÔºàÁßíÔºâ",
      reset: "„É™„Çª„ÉÉ„Éà", close: "Êàª„Çã", start: "„Çπ„Çø„Éº„Éà",
      pause: "‰∏ÄÊôÇÂÅúÊ≠¢", resume: "ÂÜçÈñã", quit: "„Éõ„Éº„É†„Å∏", win: "üèÜ „Ç≤„Éº„É†ÁµÇ‰∫Ü (ÂãùÂà©)"
    },
    en: {
      langLabel: "üá∫üá∏ English", goTimer: "GAME START", hint: "TAP: NEXT / TRIPLE: BACK / HOLD: SETTINGS",
      lblSettingsTitle: "SETTINGS", lblCount: "PLAYERS", lblLimit: "TIME LIMIT (sec)",
      reset: "RESET", close: "BACK", start: "START GAME",
      pause: "PAUSED", resume: "RESUME", quit: "HOME", win: "üèÜ FINISH (WINNER!)"
    }
  };

  // Audio
  let actx = null;
  const getCtx = () => { if(!actx) actx = new (window.AudioContext || window.webkitAudioContext)(); return actx; };
  const vibrate = (p) => { if("vibrate" in navigator) navigator.vibrate(p); };
  const tone = (ms, freq, type, gainVol=0.05) => {
    if(muted) return;
    try {
      const c = getCtx(); const o = c.createOscillator(); const g = c.createGain();
      o.type = type; o.frequency.value = freq; const now = c.currentTime;
      g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(gainVol, now+0.01);
      g.gain.exponentialRampToValueAtTime(0.001, now+ms/1000);
      o.connect(g); g.connect(c.destination); o.start(now); o.stop(now+ms/1000+0.1);
      setTimeout(() => { o.disconnect(); g.disconnect(); }, ms+200);
    } catch(e){}
  };

  const sounds = {
    click: () => tone(80, 1100, "square", 0.04),
    back: () => tone(90, 740, "square", 0.04),
    warn: () => tone(50, 1400, "square", 0.03),
    alarm: () => { tone(250, 520, "sawtooth", 0.05); setTimeout(()=>tone(250, 420, "sawtooth", 0.05), 280); vibrate([200,100,200]); },
    open: () => tone(150, 600, "sine", 0.05),
    win: () => {
      if(muted) return;
      setTimeout(()=>tone(200, 523, "square"), 0);
      setTimeout(()=>tone(200, 659, "square"), 200);
      setTimeout(()=>tone(400, 784, "square"), 400);
      setTimeout(()=>tone(600, 1046, "square"), 800);
    }
  };

  // --- Confetti Logic ---
  const fireConfetti = () => {
    const canvas = $("confettiCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const particles = [];
    const colors = ['#ff4d4d', '#2a63ff', '#ffd24d', '#57d6a3', '#ffffff'];
    
    for(let i=0; i<150; i++){
      particles.push({
        x: canvas.width/2, y: canvas.height/2,
        vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15 - 5,
        color: colors[Math.floor(Math.random()*colors.length)],
        size: Math.random()*8+4, life: 100
      });
    }

    const draw = () => {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      let active = false;
      particles.forEach(p => {
        if(p.life > 0){
          active = true;
          p.x += p.vx; p.y += p.vy; p.vy += 0.3; p.life--;
          ctx.fillStyle = p.color;
          ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
        }
      });
      if(active) requestAnimationFrame(draw);
      else ctx.clearRect(0,0,canvas.width,canvas.height);
    };
    draw();
  };

  // --- Logic ---
  const applyLang = () => {
    const t = TRANS[currentLang];
    langBtn.textContent = t.langLabel;
    $("goTimer").textContent = t.goTimer; $("hint").textContent = t.hint;
    $("lblSettingsTitle").textContent = t.lblSettingsTitle; $("lblCount").textContent = t.lblCount; $("lblLimit").textContent = t.lblLimit;
    $("reset").textContent = t.reset; $("close").textContent = t.close; $("start").textContent = t.start;
    $("pauseTitle").textContent = t.pause; 
    btnResume.textContent = t.resume; btnQuit.textContent = t.quit; btnWin.textContent = t.win;
    
    for(let i=1; i<=5; i++) $(`lblP${i}`).textContent = currentLang==="jp" ? `„Éó„É¨„Ç§„É§„Éº${i}` : `PLAYER ${i}`;
    localStorage.setItem("rumi_lang", currentLang);
  };

  const updateUI = () => {
    const m = Math.floor(remaining/60); const s = remaining % 60;
    timeEl.textContent = `${m}:${String(s).padStart(2,"0")}`;
    nameEl.textContent = players[idx] || "-";
    const c = THEME[idx % THEME.length] || "#fff";
    document.documentElement.style.setProperty("--theme", c);
    play.classList.add("theming");
    progressFill.style.background = c;
    progressFill.style.width = limit > 0 ? `${(remaining/limit)*100}%` : "0%";
  };

  const tick = () => {
    if(!playing || paused) return;
    if(remaining <= 10 && remaining > 0) { sounds.warn(); document.body.classList.add("warning"); }
    else document.body.classList.remove("warning");
    remaining--;
    updateUI();
    if(remaining < 0) {
      clearInterval(timer); remaining = 0; updateUI(); sounds.alarm();
      document.body.classList.add("timeoutFlash");
      setTimeout(()=>document.body.classList.remove("timeoutFlash"), 400);
    }
  };

  const startTurn = () => {
    clearInterval(timer); remaining = limit; document.body.classList.remove("warning");
    updateUI(); timer = setInterval(tick, 1000);
  };

  const next = () => { idx = (idx+1)%players.length; sounds.click(); startTurn(); };
  const prev = () => { idx = (idx-1+players.length)%players.length; sounds.back(); startTurn(); };

  // --- Controls ---
  const toggleMute = () => {
    muted = !muted;
    const path = muted 
      ? "M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"
      : "M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z";
    $("iconSound").innerHTML = `<path d="${path}"/>`;
  };

  const doPause = () => {
    if(!playing) return;
    paused = true; clearInterval(timer);
    pauseOverlay.classList.add("open");
  };

  const doResume = () => {
    paused = false; pauseOverlay.classList.remove("open");
    timer = setInterval(tick, 1000);
  };

  const doQuit = () => {
    pauseOverlay.classList.remove("open");
    play.classList.remove("active-press");
    playing = false; paused = false; clearInterval(timer);
    $("home").classList.remove("hidden");
  };

  const doWin = () => {
    pauseOverlay.classList.remove("open");
    playing = false; paused = false; clearInterval(timer);
    fireConfetti();
    sounds.win();
    setTimeout(() => { $("home").classList.remove("hidden"); }, 2500);
  };

  // --- Listeners ---
  $("btnPause").onclick = doPause;
  $("btnMute").onclick = toggleMute;
  btnResume.onclick = doResume;
  btnQuit.onclick = doQuit;
  btnWin.onclick = doWin;
  
  langBtn.onclick = () => { currentLang = currentLang==="jp"?"en":"jp"; sounds.click(); applyLang(); };
  $("goTimer").onclick = () => { getCtx().resume(); $("home").classList.add("hidden"); $("settingsBackdrop").classList.add("open"); };
  
  $("start").onclick = () => {
    if('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(()=>{});
    const cVal = $("count").value; localStorage.setItem("rumi_count", cVal);
    const lVal = $("limit").value; localStorage.setItem("rumi_limit", lVal);
    limit = Number(lVal);
    players = [...document.querySelectorAll(".pname")].slice(0,Number(cVal)).map((inp,i)=>inp.value||`P${i+1}`);
    localStorage.setItem("rumi_players", JSON.stringify(players.map((_,i)=>document.querySelectorAll(".pname")[i].value)));
    
    idx = 0; playing = true; paused = false;
    $("settingsBackdrop").classList.remove("open");
    startTurn();
  };

  $("close").onclick = () => { $("settingsBackdrop").classList.remove("open"); $("home").classList.remove("hidden"); };
  $("reset").onclick = () => { localStorage.removeItem("rumi_players"); [...document.querySelectorAll(".pname")].forEach((p,i)=>p.value=`P${i+1}`); sounds.back(); };
  $("count").onchange = () => { const n = Number($("count").value); [...document.querySelectorAll(".playerWrap")].forEach((w,i)=>w.classList.toggle("hidden", i>=n)); };

  // Tap Logic
  let tapCnt=0, tapTimer=null, holdTimer=null;
  const zone = $("centerTap");
  
  zone.onpointerdown = (e) => {
    if(!playing || paused) return;
    play.classList.add("active-press"); setTimeout(()=>play.classList.remove("active-press"),100);
    const r = document.createElement("div"); r.className="ripple";
    const s = Math.max(window.innerWidth, window.innerHeight);
    r.style.width=r.style.height=`${s}px`; r.style.left=`${e.clientX-s/2}px`; r.style.top=`${e.clientY-s/2}px`;
    play.appendChild(r); setTimeout(()=>r.remove(),500);

    holdTimer = setTimeout(()=>{
      holdTimer=null; playing=false; clearInterval(timer); sounds.open();
      $("settingsBackdrop").classList.add("open");
    }, 1500);
  };
  const clearHold = () => { if(holdTimer){ clearTimeout(holdTimer); holdTimer=null; }};
  zone.onpointerup = zone.onpointercancel = zone.onpointerleave = clearHold;
  zone.onclick = () => {
    if(!playing || paused) return;
    tapCnt++; if(tapTimer) clearTimeout(tapTimer);
    tapTimer = setTimeout(()=>{ if(tapCnt>=3) prev(); else next(); tapCnt=0; }, 250);
  };

  // Init
  try{
    const sl = localStorage.getItem("rumi_lang"); if(sl) currentLang=sl;
    const sc = localStorage.getItem("rumi_count"); if(sc) $("count").value=sc;
    const sli = localStorage.getItem("rumi_limit"); if(sli) $("limit").value=sli;
    const sp = JSON.parse(localStorage.getItem("rumi_players"));
    if(sp) sp.forEach((n,i)=>{ if(document.querySelectorAll(".pname")[i]) document.querySelectorAll(".pname")[i].value=n; });
  }catch(e){}
  applyLang(); $("count").onchange();
})();
</script>
</body>
</html>
