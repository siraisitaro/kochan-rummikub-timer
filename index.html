<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Rumi-TIMER!</title>
<meta name="theme-color" content="#121212">
<meta name="description" content="ラミーキューブ専用の高機能ターンタイマー">

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#121212;
    --panel:#171a1f;
    --text:#ffffff;
    --muted:#b7c0cc;
    --theme:#4f6d8a;
    --themeSoft: rgba(79,109,138,.22);
    --accent:#2a63ff;
    --danger:#ff3b3b;
    --mono: "Roboto Mono", monospace;
    font-family: system-ui, -apple-system, sans-serif;
  }

  body{
    margin:0;
    background: var(--bg);
    color: var(--text);
    overflow: hidden;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }

  /* ===== HOME ===== */
  #home{
    position: fixed; inset: 0;
    display:flex; flex-direction:column;
    align-items:center; justify-content:flex-end;
    padding-bottom: 80px; z-index: 60;
    background: #1a2a6c;
  }
  .home-bg{
    position: fixed; inset: 0;
    background: url("home-bg.png") center bottom / cover no-repeat;
    z-index: -1;
  }
  .homeCard{
    background: transparent;
    width: 100%; display: flex; justify-content: center;
  }
  .homeTitle{ display: none; }
  
  .homeBtnPrimary{
    background: linear-gradient(180deg, #ff4d4d, #c41e1e);
    border: 3px solid #fff;
    border-radius: 50px;
    padding: 0 40px;
    height: 64px;
    font-size: 20px;
    font-weight: 800;
    letter-spacing: 2px;
    color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    animation: float 2s infinite ease-in-out;
    cursor: pointer;
  }
  @keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-6px); }
    100% { transform: translateY(0px); }
  }

  #home.hidden{ display:none; }

  /* ===== PLAY ===== */
  #play{
    position: fixed; inset: 0;
    background: radial-gradient(circle at 50% 40%, rgba(255,255,255,.04), transparent 60%), var(--bg);
    border: 8px solid rgba(255,255,255,.06);
    transition: border-color .15s;
  }
  #play.theming{
    border-color: color-mix(in srgb, var(--theme) 70%, rgba(255,255,255,.1));
  }

  #progressOuter{
    position: absolute; top: 0; left: 0; right: 0; height: 10px;
    background: rgba(255,255,255,.06); overflow: hidden;
  }
  #progressFill{
    height: 100%; width: 0%;
    background: linear-gradient(90deg, rgba(255,255,255,.2), rgba(255,255,255,.05));
    transition: width 0.2s linear;
  }

  #centerTap{
    position: absolute; inset: 0;
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    text-align:center;
  }

  #time{
    font-family: var(--mono); font-weight: 700;
    font-size: min(24vw, 180px); line-height: 1; margin-top:10px;
    text-shadow: 0 10px 40px rgba(0,0,0,.6);
    font-variant-numeric: tabular-nums;
  }
  #playerName{
    margin-top: 10px; font-family: var(--mono);
    font-weight: 700; font-size: min(10vw, 50px);
    text-shadow: 0 2px 10px rgba(0,0,0,.5);
  }
  #hint{
    position: absolute; bottom: 30px;
    font-size: 13px; color: var(--muted); opacity: .6;
    pointer-events: none;
  }

  .warning #time{ color: #ff4d4d; animation: pulse .75s infinite; }
  @keyframes pulse{ 50%{ transform: scale(1.05); } }

  .timeoutFlash #play{
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.1), 0 0 60px rgba(255,77,77,.4);
    background-color: rgba(255,0,0,0.15);
  }

  .ripple{
    position:absolute; border-radius: 50%;
    background: rgba(255,255,255,.15);
    transform: scale(0); animation: ripple .4s ease-out;
    pointer-events:none;
  }
  @keyframes ripple{ to { transform: scale(1.5); opacity: 0; } }

  /* ===== SETTINGS ===== */
  #settingsBackdrop{
    position: fixed; inset: 0; background: rgba(0,0,0,.85);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    display: none; align-items: center; justify-content: center;
    padding: 16px; z-index: 100; opacity: 0; transition: opacity 0.2s;
  }
  #settingsBackdrop.open{ display:flex; opacity: 1; }

  #settingsModal{
    width: min(600px, 100%); background: var(--panel);
    border: 1px solid rgba(255,255,255,.15); border-radius: 24px;
    display: flex; flex-direction: column; max-height: 90vh;
    box-shadow: 0 20px 60px rgba(0,0,0,.7);
  }
  #settingsBody{ padding: 20px; overflow-y: auto; }
  
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .playersGrid{ 
    display:grid; grid-template-columns: 1fr 1fr; gap: 12px; 
    margin-top: 24px; padding-top: 20px; 
    border-top: 1px solid rgba(255,255,255,0.1); 
  }
  
  label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
  input, select{
    width:100%; height: 50px; padding: 0 16px;
    border-radius: 12px; border: 1px solid rgba(255,255,255,.15);
    background: rgba(0,0,0,.3); color: white;
    font-size: 16px; box-sizing: border-box;
  }
  .playerWrap.hidden{ display:none; }

  #settingsFooter{
    padding: 16px 20px; background: rgba(20,20,25,.95);
    border-top: 1px solid rgba(255,255,255,.1);
    display:flex; gap: 10px;
  }
  .btn{
    flex:1; height: 54px; border-radius: 14px; border:none;
    font-weight:700; font-size:16px; cursor:pointer; color: white;
  }
  .btnPrimary{ background: #2a63ff; }
  .btnSecondary{ background: rgba(255,255,255,.1); max-width: 80px; }
  .btnDanger{ background: rgba(255,77,77,.15); color: #ff6666; max-width: 80px; }
</style>
</head>

<body>
  <div id="home">
    <div class="home-bg"></div>
    <div class="homeCard">
      <button id="goTimer" class="homeBtnPrimary">GAME START</button>
    </div>
  </div>

  <div id="play" class="theming">
    <div id="progressOuter"><div id="progressFill"></div></div>
    
    <div id="centerTap">
      <div id="time">0:00</div>
      <div id="playerName">-</div>
      <div id="hint">TAP: NEXT / TRIPLE: BACK / HOLD: SETTINGS</div>
    </div>
  </div>

  <div id="settingsBackdrop">
    <div id="settingsModal">
      <div style="padding: 20px 20px 0;"><h2>Settings</h2></div>
      <div id="settingsBody">
        <div class="grid">
          <div><label>Players</label><select id="count"><option>2</option><option selected>3</option><option>4</option><option>5</option></select></div>
          <div><label>Time (sec)</label><input id="limit" type="number" value="60"></div>
        </div>
        <div class="playersGrid" id="playersGrid">
          <div class="playerWrap" data-p="1"><label>P1 Name</label><input class="pname" id="p1" value="Player 1"></div>
          <div class="playerWrap" data-p="2"><label>P2 Name</label><input class="pname" id="p2" value="Player 2"></div>
          <div class="playerWrap" data-p="3"><label>P3 Name</label><input class="pname" id="p3" value="Player 3"></div>
          <div class="playerWrap" data-p="4"><label>P4 Name</label><input class="pname" id="p4" value="Player 4"></div>
          <div class="playerWrap" data-p="5"><label>P5 Name</label><input class="pname" id="p5" value="Player 5"></div>
        </div>
      </div>
      <div id="settingsFooter">
        <button id="reset" class="btn btnDanger">Reset</button>
        <button id="close" class="btn btnSecondary">Back</button>
        <button id="start" class="btn btnPrimary">Start Game</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // --- Service Worker Registration (PWA) ---
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('SW Registered'))
      .catch(e => console.log('SW Fail', e));
  }

  const $ = (id) => document.getElementById(id);
  
  // Elements
  const home = $("home");
  const play = $("play");
  const progressFill = $("progressFill");
  const timeEl = $("time");
  const nameEl = $("playerName");
  
  const modal = $("settingsBackdrop");
  const countEl = $("count");
  const limitEl = $("limit");
  const inputs = [...document.querySelectorAll(".pname")];
  const wraps = [...document.querySelectorAll(".playerWrap")];

  // Colors
  const THEME = ["#ff4d4d", "#2a63ff", "#ffd24d", "#57d6a3", "#b070ff"];
  
  // State
  let players = [];
  let limit = 60;
  let idx = 0;
  let remaining = 0;
  let timer = null;
  let playing = false;
  let wakeLock = null;

  // Audio Context (Singleton)
  let actx = null;
  const getCtx = () => {
    if(!actx) actx = new (window.AudioContext || window.webkitAudioContext)();
    return actx;
  };

  // --- Vibration Helper (追加機能) ---
  const vibrate = (pattern) => {
    if("vibrate" in navigator) navigator.vibrate(pattern);
  };

  // Sound Engine
  const tone = (ms, freq, type, gainVol=0.05) => {
    try {
      const c = getCtx();
      const o = c.createOscillator();
      const g = c.createGain();
      o.type = type; o.frequency.value = freq;
      const now = c.currentTime;
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(gainVol, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.001, now + ms/1000);
      o.connect(g); g.connect(c.destination);
      o.start(now); o.stop(now + ms/1000 + 0.1);
      setTimeout(() => { o.disconnect(); g.disconnect(); }, ms+200);
    } catch(e){}
  };

  const sounds = {
    click: () => { tone(80, 1100, "square", 0.04); vibrate(15); }, // 微細な振動
    back:  () => { tone(90, 740, "square", 0.04); vibrate(20); },
    warn:  () => { tone(50, 1400, "square", 0.03); },
    alarm: () => { 
      tone(250, 520, "sawtooth", 0.05); 
      setTimeout(() => tone(250, 420, "sawtooth", 0.05), 280);
      vibrate([200, 100, 200]); // ブブッ、ブブッ
    },
    open:  () => { tone(150, 600, "sine", 0.05); vibrate(30); }
  };

  // --- Logic ---
  const loadSettings = () => {
    // LocalStorageから読み込み (追加機能)
    try {
      const saved = JSON.parse(localStorage.getItem("rumi_players"));
      if(saved && Array.isArray(saved)){
        saved.forEach((name, i) => { if(inputs[i]) inputs[i].value = name; });
      }
      const savedCount = localStorage.getItem("rumi_count");
      if(savedCount) countEl.value = savedCount;
      const savedLimit = localStorage.getItem("rumi_limit");
      if(savedLimit) limitEl.value = savedLimit;
    } catch(e){}
    applyVis();
  };

  const saveSettings = () => {
    // LocalStorageへ保存 (追加機能)
    const currentNames = inputs.map(i => i.value);
    localStorage.setItem("rumi_players", JSON.stringify(currentNames));
    localStorage.setItem("rumi_count", countEl.value);
    localStorage.setItem("rumi_limit", limitEl.value);
  };

  const applyVis = () => {
    const n = Number(countEl.value);
    wraps.forEach((w, i) => w.classList.toggle("hidden", i >= n));
  };

  const updateUI = () => {
    const m = Math.floor(remaining/60);
    const s = remaining % 60;
    timeEl.textContent = `${m}:${String(s).padStart(2,"0")}`;
    nameEl.textContent = players[idx] || "-";
    
    // Theme
    const c = THEME[idx % THEME.length] || "#fff";
    document.documentElement.style.setProperty("--theme", c);
    play.classList.add("theming");
    progressFill.style.background = c;
    
    const pct = limit > 0 ? (remaining/limit)*100 : 0;
    progressFill.style.width = `${pct}%`;
  };

  const tick = () => {
    if(!playing) return;
    if(remaining <= 10 && remaining > 0) { sounds.warn(); document.body.classList.add("warning"); }
    else document.body.classList.remove("warning");
    
    remaining--;
    updateUI();
    
    if(remaining < 0) {
      clearInterval(timer);
      remaining = 0; updateUI();
      sounds.alarm();
      document.body.classList.add("timeoutFlash");
      setTimeout(()=>document.body.classList.remove("timeoutFlash"), 400);
    }
  };

  const startTurn = () => {
    clearInterval(timer);
    remaining = limit;
    document.body.classList.remove("warning");
    updateUI();
    timer = setInterval(tick, 1000);
  };

  const next = () => { idx = (idx+1)%players.length; sounds.click(); startTurn(); };
  const prev = () => { idx = (idx-1+players.length)%players.length; sounds.back(); startTurn(); };

  // --- Interaction ---
  $("goTimer").onclick = () => {
    getCtx().resume();
    home.classList.add("hidden");
    modal.classList.add("open");
    loadSettings(); // 設定画面を開くときにロード
  };

  $("start").onclick = () => {
    // Wake Lock
    if('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(()=>{});
    
    saveSettings(); // 開始時にセーブ
    
    const n = Number(countEl.value);
    limit = Number(limitEl.value);
    players = inputs.slice(0,n).map((inp,i) => inp.value || `P${i+1}`);
    idx = 0;
    playing = true;
    modal.classList.remove("open");
    startTurn();
  };

  $("close").onclick = () => {
    if(playing) modal.classList.remove("open");
    else { modal.classList.remove("open"); home.classList.remove("hidden"); }
  };
  
  $("reset").onclick = () => {
    localStorage.removeItem("rumi_players"); // リセットで保存データも消去
    inputs.forEach((inp,i) => inp.value = `Player ${i+1}`);
    sounds.back();
  };

  countEl.onchange = applyVis;

  // Tap & Hold Logic
  let tapCnt = 0;
  let tapTimer = null;
  let holdTimer = null;
  const zone = $("centerTap");

  const ripple = (x,y) => {
    const r = document.createElement("div");
    r.className = "ripple";
    const s = Math.max(window.innerWidth, window.innerHeight);
    r.style.width=r.style.height=`${s}px`;
    r.style.left=`${x-s/2}px`; r.style.top=`${y-s/2}px`;
    play.appendChild(r);
    setTimeout(()=>r.remove(), 500);
  };

  zone.onpointerdown = (e) => {
    if(!playing) return;
    ripple(e.clientX, e.clientY);
    holdTimer = setTimeout(() => {
      holdTimer = null;
      playing = false; clearInterval(timer);
      sounds.open();
      modal.classList.add("open");
    }, 1500); // 1.5秒長押し
  };
  
  const clearHold = () => { if(holdTimer){ clearTimeout(holdTimer); holdTimer=null; }};
  zone.onpointerup = clearHold;
  zone.onpointercancel = clearHold;
  zone.onpointerleave = clearHold;

  zone.onclick = (e) => {
    if(!playing) return;
    tapCnt++;
    if(tapTimer) clearTimeout(tapTimer);
    tapTimer = setTimeout(() => {
      if(tapCnt >= 3) prev();
      else next();
      tapCnt = 0;
    }, 250);
  };

  // Init
  loadSettings();
})();
</script>
</body>
</html>
