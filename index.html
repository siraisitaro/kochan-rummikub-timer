<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Rumi-TIMER!</title>
<meta name="theme-color" content="#121212">
<meta name="description" content="ãƒ©ãƒŸãƒ¼ã‚­ãƒ¥ãƒ¼ãƒ–å°‚ç”¨ã®é«˜æ©Ÿèƒ½ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒãƒ¼">

<!-- PWAè¨­å®š -->
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon.png">
<!-- iOSç”¨ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¨­å®š -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Fonts: Roboto Mono (æ•°å­—ç”¨) + Noto Sans JP (æ—¥æœ¬èªç”¨) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700&family=Roboto+Mono:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#121212;
    --panel:#171a1f;
    --text:#ffffff;
    --muted:#b7c0cc;
    --theme:#4f6d8a;
    --themeSoft: rgba(79,109,138,.22);
    --accent:#2a63ff;
    --danger:#ff3b3b;
    
    /* ãƒ•ã‚©ãƒ³ãƒˆå®šç¾© */
    --mono: "Roboto Mono", monospace;
    --sans: "Noto Sans JP", system-ui, -apple-system, sans-serif;
  }

  /* ===== åŸºæœ¬è¨­å®š ===== */
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans); /* å…¨ä½“ã‚’Noto Sans JPã« */
    overflow: hidden;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;

    /* é•·æŠ¼ã—ãƒ»é¸æŠç¦æ­¢ (ã‚¢ãƒ—ãƒªã£ã½ã•ã®è‚) */
    user-select: none; -webkit-user-select: none;
    -webkit-touch-callout: none;
  }

  /* å…¥åŠ›æ¬„ã ã‘ã¯æ“ä½œè¨±å¯ */
  input, select, textarea {
    user-select: auto; -webkit-user-select: auto;
    -webkit-touch-callout: default;
    font-family: var(--sans);
  }

  /* ===== HOME ===== */
  #home{
    position: fixed; inset: 0;
    display:flex; flex-direction:column;
    align-items:center; justify-content:flex-end;
    padding-bottom: max(env(safe-area-inset-bottom), 80px); /* iPhoneä¸‹éƒ¨ãƒãƒ¼å¯¾å¿œ */
    z-index: 60;
    background: #1a2a6c;
    transition: opacity 0.3s ease;
  }
  .home-bg{
    position: fixed; inset: 0;
    background: url("home-bg.png") center bottom / cover no-repeat;
    z-index: -1;
  }
  .homeCard{
    background: transparent;
    width: 100%; display: flex; justify-content: center;
  }
  
  .homeBtnPrimary{
    background: linear-gradient(180deg, #ff4d4d, #c41e1e);
    border: 3px solid #fff;
    border-radius: 50px;
    padding: 0 40px;
    height: 64px;
    font-size: 20px;
    font-weight: 800;
    letter-spacing: 1px;
    color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    animation: float 2s infinite ease-in-out;
    cursor: pointer;
    will-change: transform;
    transition: transform 0.1s, filter 0.1s, box-shadow 0.1s;
    font-family: var(--sans);
  }
  .homeBtnPrimary:active {
    transform: scale(0.92);
    filter: brightness(0.9);
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }
  @keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-6px); }
    100% { transform: translateY(0px); }
  }

  #langSwitch {
    position: absolute;
    top: max(env(safe-area-inset-top), 20px); /* ãƒãƒƒãƒå›é¿ */
    right: 20px;
    background: rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-family: var(--mono);
    font-size: 14px;
    cursor: pointer;
    backdrop-filter: blur(4px);
    transition: transform 0.1s, background 0.1s;
  }
  #langSwitch:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }

  #home.hidden{ opacity: 0; pointer-events: none; }

  /* ===== PLAY (The Main Timer) ===== */
  #play{
    position: fixed; inset: 0;
    background: radial-gradient(circle at 50% 40%, rgba(255,255,255,.04), transparent 60%), var(--bg);
    border: 8px solid rgba(255,255,255,.06);
    transition: border-color 0.2s, transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    
    /* ã“ã‚Œã§ãƒ—ãƒ¬ã‚¤ç”»é¢å…¨ä½“ãŒã€Œç‰©ç†ã‚¹ã‚¤ãƒƒãƒã€ã«ãªã‚Šã¾ã™ */
    transform-origin: center;
  }
  
  /* ãƒ—ãƒ¬ã‚¤ä¸­ã®ã‚¿ãƒƒãƒ—ã§ç”»é¢å…¨ä½“ãŒæ²ˆã‚€æ¼”å‡º */
  #play.active-press {
    transform: scale(0.97);
    border-color: rgba(255,255,255,0.15);
  }

  #play.theming{
    border-color: color-mix(in srgb, var(--theme) 70%, rgba(255,255,255,.1));
  }

  #progressOuter{
    position: absolute; top: 0; left: 0; right: 0; height: 10px;
    background: rgba(255,255,255,.06); overflow: hidden;
  }
  #progressFill{
    height: 100%; width: 0%;
    background: linear-gradient(90deg, rgba(255,255,255,.2), rgba(255,255,255,.05));
    transition: width 0.2s linear;
  }

  #centerTap{
    position: absolute; inset: 0;
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    text-align:center;
    /* ã‚¬ãƒ¼ãƒ‰è¨­å®š */
    -webkit-touch-callout: none;
    -webkit-user-select: none;
  }

  #time{
    font-family: var(--mono); font-weight: 700;
    font-size: min(24vw, 180px); line-height: 1; margin-top:10px;
    text-shadow: 0 10px 40px rgba(0,0,0,.6);
    font-variant-numeric: tabular-nums;
  }
  #playerName{
    margin-top: 10px; font-family: var(--mono);
    font-weight: 700; font-size: min(10vw, 50px);
    text-shadow: 0 2px 10px rgba(0,0,0,.5);
  }
  #hint{
    position: absolute; bottom: max(env(safe-area-inset-bottom), 30px);
    font-size: 13px; color: var(--muted); opacity: .7;
    pointer-events: none; width: 90%;
    font-family: var(--sans); letter-spacing: 0.5px;
  }

  .warning #time{ color: #ff4d4d; animation: pulse .75s infinite; }
  @keyframes pulse{ 50%{ transform: scale(1.05); } }

  .timeoutFlash #play{
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.1), 0 0 60px rgba(255,77,77,.4);
    background-color: rgba(255,0,0,0.15);
  }

  .ripple{
    position:absolute; border-radius: 50%;
    background: rgba(255,255,255,.12);
    transform: scale(0); animation: ripple .4s ease-out;
    pointer-events:none;
  }
  @keyframes ripple{ to { transform: scale(1.8); opacity: 0; } }

  /* ===== SETTINGS MODAL ===== */
  #settingsBackdrop{
    position: fixed; inset: 0; background: rgba(0,0,0,.85);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    display: none; align-items: center; justify-content: center;
    padding: 16px; z-index: 100;
    opacity: 0; transition: opacity 0.25s ease;
  }
  #settingsBackdrop.open{ display:flex; opacity: 1; }

  #settingsModal{
    width: min(600px, 100%); background: var(--panel);
    border: 1px solid rgba(255,255,255,.15); border-radius: 24px;
    display: flex; flex-direction: column; max-height: 85vh;
    box-shadow: 0 20px 60px rgba(0,0,0,.7);
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å‡ºç¾ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹ã‹ã‚‰ãµã‚ã£ã¨ï¼‰ */
    transform: translateY(30px) scale(0.95);
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }
  #settingsBackdrop.open #settingsModal {
    transform: translateY(0) scale(1);
  }

  #settingsBody{ padding: 20px; overflow-y: auto; }
  
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .playersGrid{ 
    display:grid; grid-template-columns: 1fr 1fr; gap: 12px; 
    margin-top: 24px; padding-top: 20px; 
    border-top: 1px solid rgba(255,255,255,0.1); 
  }
  
  label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; font-weight: 700;}
  input, select{
    width:100%; height: 50px; padding: 0 16px;
    border-radius: 12px; border: 1px solid rgba(255,255,255,.15);
    background: rgba(0,0,0,.3); color: white;
    font-size: 16px; box-sizing: border-box;
    outline: none;
  }
  input:focus, select:focus { border-color: var(--accent); background: rgba(0,0,0,.5); }
  .playerWrap.hidden{ display:none; }

  #settingsFooter{
    padding: 16px 20px; background: rgba(20,20,25,.95);
    border-top: 1px solid rgba(255,255,255,.1);
    display:flex; gap: 10px;
    padding-bottom: max(env(safe-area-inset-bottom), 16px); /* iPhoneä¸‹éƒ¨ãƒãƒ¼å¯¾å¿œ */
  }
  .btn{
    flex:1; height: 54px; border-radius: 14px; border:none;
    font-weight:700; font-size:16px; cursor:pointer; color: white;
    transition: transform 0.1s, filter 0.1s;
    font-family: var(--sans);
  }
  .btn:active { transform: scale(0.96); filter: brightness(0.9); }
  .btnPrimary{ background: #2a63ff; box-shadow: 0 4px 12px rgba(42,99,255,0.3); }
  .btnSecondary{ background: rgba(255,255,255,.1); max-width: 80px; }
  .btnDanger{ background: rgba(255,77,77,.15); color: #ff6666; max-width: 80px; }
</style>
</head>

<body>
  <div id="home">
    <div class="home-bg"></div>
    <button id="langSwitch">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
    <div class="homeCard">
      <button id="goTimer" class="homeBtnPrimary">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
    </div>
  </div>

  <div id="play" class="theming">
    <div id="progressOuter"><div id="progressFill"></div></div>
    
    <div id="centerTap">
      <div id="time">0:00</div>
      <div id="playerName">-</div>
      <div id="hint">ã‚¿ãƒƒãƒ—: æ¬¡ã¸ / 3å›: æˆ»ã‚‹ / é•·æŠ¼ã—: è¨­å®š</div>
    </div>
  </div>

  <div id="settingsBackdrop">
    <div id="settingsModal">
      <div style="padding: 20px 20px 0;"><h2 id="lblSettingsTitle">è¨­å®š</h2></div>
      <div id="settingsBody">
        <div class="grid">
          <div><label id="lblCount">å‚åŠ äººæ•°</label><select id="count"><option>2</option><option selected>3</option><option>4</option><option>5</option></select></div>
          <div><label id="lblLimit">åˆ¶é™æ™‚é–“ï¼ˆç§’ï¼‰</label><input id="limit" type="number" value="60"></div>
        </div>
        <div class="playersGrid" id="playersGrid">
          <div class="playerWrap" data-p="1"><label id="lblP1">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</label><input class="pname" id="p1" value="P1"></div>
          <div class="playerWrap" data-p="2"><label id="lblP2">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2</label><input class="pname" id="p2" value="P2"></div>
          <div class="playerWrap" data-p="3"><label id="lblP3">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3</label><input class="pname" id="p3" value="P3"></div>
          <div class="playerWrap" data-p="4"><label id="lblP4">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4</label><input class="pname" id="p4" value="P4"></div>
          <div class="playerWrap" data-p="5"><label id="lblP5">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼5</label><input class="pname" id="p5" value="P5"></div>
        </div>
      </div>
      <div id="settingsFooter">
        <button id="reset" class="btn btnDanger">ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="close" class="btn btnSecondary">æˆ»ã‚‹</button>
        <button id="start" class="btn btnPrimary">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // --- Service Worker (PWA) ---
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(e => console.log(e));
  }

  const $ = (id) => document.getElementById(id);
  
  // Elements
  const home = $("home");
  const play = $("play");
  const progressFill = $("progressFill");
  const timeEl = $("time");
  const nameEl = $("playerName");
  const hintEl = $("hint");
  const langBtn = $("langSwitch");
  
  const modal = $("settingsBackdrop");
  const countEl = $("count");
  const limitEl = $("limit");
  const inputs = [...document.querySelectorAll(".pname")];
  const wraps = [...document.querySelectorAll(".playerWrap")];

  const THEME = ["#ff4d4d", "#2a63ff", "#ffd24d", "#57d6a3", "#b070ff"];
  
  let players = [];
  let limit = 60;
  let idx = 0;
  let remaining = 0;
  let timer = null;
  let playing = false;
  let currentLang = "jp";

  // Dictionary
  const TRANS = {
    jp: {
      langLabel: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª",
      goTimer: "ã‚²ãƒ¼ãƒ é–‹å§‹",
      hint: "ã‚¿ãƒƒãƒ—: æ¬¡ã¸ / 3å›: æˆ»ã‚‹ / é•·æŠ¼ã—: è¨­å®š",
      lblSettingsTitle: "è¨­å®š",
      lblCount: "å‚åŠ äººæ•°",
      lblLimit: "åˆ¶é™æ™‚é–“ï¼ˆç§’ï¼‰",
      lblP1: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1", lblP2: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2", lblP3: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3", lblP4: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4", lblP5: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼5",
      reset: "ãƒªã‚»ãƒƒãƒˆ", close: "æˆ»ã‚‹", start: "ã‚¹ã‚¿ãƒ¼ãƒˆ"
    },
    en: {
      langLabel: "ğŸ‡ºğŸ‡¸ English",
      goTimer: "GAME START",
      hint: "TAP: NEXT / TRIPLE: BACK / HOLD: SETTINGS",
      lblSettingsTitle: "SETTINGS",
      lblCount: "PLAYERS",
      lblLimit: "TIME LIMIT (sec)",
      lblP1: "PLAYER 1", lblP2: "PLAYER 2", lblP3: "PLAYER 3", lblP4: "PLAYER 4", lblP5: "PLAYER 5",
      reset: "RESET", close: "BACK", start: "START GAME"
    }
  };

  // Audio Context
  let actx = null;
  const getCtx = () => {
    if(!actx) actx = new (window.AudioContext || window.webkitAudioContext)();
    return actx;
  };

  const vibrate = (pattern) => {
    if("vibrate" in navigator) navigator.vibrate(pattern);
  };

  const tone = (ms, freq, type, gainVol=0.05) => {
    try {
      const c = getCtx();
      const o = c.createOscillator();
      const g = c.createGain();
      o.type = type; o.frequency.value = freq;
      const now = c.currentTime;
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(gainVol, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.001, now + ms/1000);
      o.connect(g); g.connect(c.destination);
      o.start(now); o.stop(now + ms/1000 + 0.1);
      setTimeout(() => { o.disconnect(); g.disconnect(); }, ms+200);
    } catch(e){}
  };

  const sounds = {
    click: () => { tone(80, 1100, "square", 0.04); vibrate(15); }, 
    back:  () => { tone(90, 740, "square", 0.04); vibrate(20); },
    warn:  () => { tone(50, 1400, "square", 0.03); },
    alarm: () => { 
      tone(250, 520, "sawtooth", 0.05); 
      setTimeout(() => tone(250, 420, "sawtooth", 0.05), 280);
      vibrate([200, 100, 200]);
    },
    open:  () => { tone(150, 600, "sine", 0.05); vibrate(30); }
  };

  // --- Logic ---
  const applyLang = () => {
    const t = TRANS[currentLang];
    langBtn.textContent = t.langLabel;
    $("goTimer").textContent = t.goTimer;
    hintEl.textContent = t.hint;
    $("lblSettingsTitle").textContent = t.lblSettingsTitle;
    $("lblCount").textContent = t.lblCount;
    $("lblLimit").textContent = t.lblLimit;
    $("lblP1").textContent = t.lblP1;
    $("lblP2").textContent = t.lblP2;
    $("lblP3").textContent = t.lblP3;
    $("lblP4").textContent = t.lblP4;
    $("lblP5").textContent = t.lblP5;
    $("reset").textContent = t.reset;
    $("close").textContent = t.close;
    $("start").textContent = t.start;
    localStorage.setItem("rumi_lang", currentLang);
  };

  const toggleLang = () => {
    currentLang = currentLang === "jp" ? "en" : "jp";
    sounds.click();
    applyLang();
  };

  const loadSettings = () => {
    try {
      const savedLang = localStorage.getItem("rumi_lang");
      if(savedLang) currentLang = savedLang;
      
      const savedNames = JSON.parse(localStorage.getItem("rumi_players"));
      if(savedNames && Array.isArray(savedNames)){
        savedNames.forEach((name, i) => { if(inputs[i]) inputs[i].value = name; });
      }
      const savedCount = localStorage.getItem("rumi_count");
      if(savedCount) countEl.value = savedCount;
      const savedLimit = localStorage.getItem("rumi_limit");
      if(savedLimit) limitEl.value = savedLimit;
    } catch(e){}
    applyLang();
    applyVis();
  };

  const saveSettings = () => {
    const currentNames = inputs.map(i => i.value);
    localStorage.setItem("rumi_players", JSON.stringify(currentNames));
    localStorage.setItem("rumi_count", countEl.value);
    localStorage.setItem("rumi_limit", limitEl.value);
  };

  const applyVis = () => {
    const n = Number(countEl.value);
    wraps.forEach((w, i) => w.classList.toggle("hidden", i >= n));
  };

  const updateUI = () => {
    const m = Math.floor(remaining/60);
    const s = remaining % 60;
    timeEl.textContent = `${m}:${String(s).padStart(2,"0")}`;
    nameEl.textContent = players[idx] || "-";
    
    const c = THEME[idx % THEME.length] || "#fff";
    document.documentElement.style.setProperty("--theme", c);
    play.classList.add("theming");
    progressFill.style.background = c;
    progressFill.style.width = limit > 0 ? `${(remaining/limit)*100}%` : "0%";
  };

  const tick = () => {
    if(!playing) return;
    if(remaining <= 10 && remaining > 0) { sounds.warn(); document.body.classList.add("warning"); }
    else document.body.classList.remove("warning");
    
    remaining--;
    updateUI();
    
    if(remaining < 0) {
      clearInterval(timer);
      remaining = 0; updateUI();
      sounds.alarm();
      document.body.classList.add("timeoutFlash");
      setTimeout(()=>document.body.classList.remove("timeoutFlash"), 400);
    }
  };

  const startTurn = () => {
    clearInterval(timer);
    remaining = limit;
    document.body.classList.remove("warning");
    updateUI();
    timer = setInterval(tick, 1000);
  };

  const next = () => { idx = (idx+1)%players.length; sounds.click(); startTurn(); };
  const prev = () => { idx = (idx-1+players.length)%players.length; sounds.back(); startTurn(); };

  // --- Interaction ---
  langBtn.onclick = toggleLang;

  $("goTimer").onclick = () => {
    getCtx().resume();
    home.classList.add("hidden");
    modal.classList.add("open");
  };

  $("start").onclick = () => {
    if('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(()=>{});
    saveSettings();
    const n = Number(countEl.value);
    limit = Number(limitEl.value);
    players = inputs.slice(0,n).map((inp,i) => inp.value || `P${i+1}`);
    idx = 0;
    playing = true;
    modal.classList.remove("open");
    startTurn();
  };

  $("close").onclick = () => {
    if(playing) modal.classList.remove("open");
    else { modal.classList.remove("open"); home.classList.remove("hidden"); }
  };
  
  $("reset").onclick = () => {
    localStorage.removeItem("rumi_players");
    inputs.forEach((inp,i) => inp.value = `P${i+1}`);
    sounds.back();
  };

  countEl.onchange = applyVis;

  // Tap & Hold Logic
  let tapCnt = 0;
  let tapTimer = null;
  let holdTimer = null;
  const zone = $("centerTap");

  // Visual feedback: Screen Press Effect
  const pressScreen = () => {
    play.classList.add("active-press");
    setTimeout(() => play.classList.remove("active-press"), 100);
  };

  const ripple = (x,y) => {
    const r = document.createElement("div");
    r.className = "ripple";
    const s = Math.max(window.innerWidth, window.innerHeight);
    r.style.width=r.style.height=`${s}px`;
    r.style.left=`${x-s/2}px`; r.style.top=`${y-s/2}px`;
    play.appendChild(r);
    setTimeout(()=>r.remove(), 500);
  };

  zone.onpointerdown = (e) => {
    if(!playing) return;
    ripple(e.clientX, e.clientY);
    pressScreen(); // ç”»é¢æ²ˆã¿è¾¼ã¿ç™ºå‹•ï¼
    
    holdTimer = setTimeout(() => {
      holdTimer = null;
      playing = false; clearInterval(timer);
      sounds.open();
      modal.classList.add("open");
    }, 1500);
  };
  
  const clearHold = () => { if(holdTimer){ clearTimeout(holdTimer); holdTimer=null; }};
  zone.onpointerup = clearHold;
  zone.onpointercancel = clearHold;
  zone.onpointerleave = clearHold;

  zone.onclick = (e) => {
    if(!playing) return;
    tapCnt++;
    if(tapTimer) clearTimeout(tapTimer);
    tapTimer = setTimeout(() => {
      if(tapCnt >= 3) prev();
      else next();
      tapCnt = 0;
    }, 250);
  };

  loadSettings();
})();
</script>
</body>
</html>
