<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Rummikub Turn Timer</title>
<meta name="theme-color" content="#121212">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#121212;
    --panel:#171a1f;
    --line:#2a2f36;
    --text:#ffffff;
    --muted:#b7c0cc;

    --theme:#4f6d8a;
    --themeSoft: rgba(79,109,138,.22);

    --accent:#2a63ff;
    --danger:#ff3b3b;

    --mono: "Roboto Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }

  body{
    margin:0;
    background: var(--bg);
    color: var(--text);
    overflow: hidden; /* スクロール防止 */
    touch-action: manipulation; /* ダブルタップズーム無効化 */
    -webkit-tap-highlight-color: transparent;
  }

/* ===== HOME (title screen) ===== */
#home{
  position: fixed;
  inset: 0;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  padding: 24px 18px 36px;
  
  /* 画像がない場合のフォールバック（グラデーション） */
  background: linear-gradient(135deg, #1e2530 0%, #000000 100%);
  z-index: 60;
}

/* 背景画像がある場合は上書き */
.home-bg{
  position: fixed;
  inset: 0;
  background: url("home.png") center / cover no-repeat;
  filter: blur(4px) brightness(0.6);
  transform: scale(1.05);
  z-index: -1;
  opacity: 0.8;
}

#home.hidden{ display:none; }

 .homeCard{
  background: rgba(20,20,20,0.75);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.15);
  padding: 24px;
  border-radius: 24px;
  width: min(100%, 400px);
  text-align: center;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

  .homeTitle{
    font-family: var(--mono);
    font-weight: 700;
    font-size: clamp(22px, 6vw, 32px);
    letter-spacing: .4px;
    margin: 0 0 24px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }
  
  .homeActions{
    display:flex;
    justify-content: center;
  }
  
  .homeBtn{
    height: 64px;
    width: 100%;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,.12);
    color: var(--text);
    font-weight: 800;
    font-size: 18px;
    cursor: pointer;
    transition: transform 0.1s active;
  }
  .homeBtn:active { transform: scale(0.98); }

  .homeBtnPrimary{
    background: linear-gradient(180deg, rgba(42,99,255,.95), rgba(42,99,255,.72));
    border-color: rgba(42,99,255,.7);
    box-shadow: 0 10px 26px rgba(42,99,255,.25);
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }

  /* ===== PLAY ===== */
  #play{
    position: fixed;
    inset: 0;
    background:
      radial-gradient(1200px 700px at 50% 40%, rgba(255,255,255,.04), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.03), transparent 25%),
      var(--bg);
    border: 10px solid rgba(255,255,255,.06);
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.02);
    transition: border-color .15s ease, box-shadow .15s ease, background .2s ease;
  }
  #play.theming{
    border-color: color-mix(in srgb, var(--theme) 70%, rgba(255,255,255,.08));
    box-shadow:
      inset 0 0 0 2px rgba(255,255,255,.03),
      0 0 0 1px rgba(255,255,255,.03),
      0 0 26px rgba(0,0,0,.45),
      0 0 44px var(--themeSoft);
  }

  #progressOuter{
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 10px;
    background: rgba(255,255,255,.06);
    overflow: hidden;
  }
  #progressFill{
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, rgba(255,255,255,.15), rgba(255,255,255,.05));
    position: relative;
    transition: width 0.2s linear; /* スムーズな減少 */
  }
  #progressFill::after{
    content:"";
    position:absolute;
    inset:0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent);
    transform: translateX(-60%);
    animation: sheen 2.2s infinite;
    opacity: .55;
  }
  @keyframes sheen{
    0% { transform: translateX(-60%); }
    100% { transform: translateX(160%); }
  }

  #centerTap{
    position: absolute;
    inset: 0;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    text-align:center;
    user-select:none;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent; /* タップ時のハイライト削除 */
  }

  #time{
    font-family: var(--mono);
    font-weight: 700;
    font-size: min(22vw, 170px);
    letter-spacing: -2px;
    line-height: 1;
    margin: 10px 0 0;
    text-shadow: 0 10px 40px rgba(0,0,0,.6);
    font-variant-numeric: tabular-nums; /* 数字の幅を固定してガタツキ防止 */
  }

  #playerName{
    margin-top: 14px;
    font-family: var(--mono);
    font-weight: 700;
    font-size: min(8vw, 48px);
    color: rgba(255,255,255,.95);
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }

  #hint{
    position: absolute;
    bottom: 30px;
    font-size: 13px;
    color: var(--muted);
    opacity: .7;
    line-height: 1.5;
    pointer-events: none;
    max-width: 80%;
  }

  .warning #time{
    color: #ff4d4d;
    animation: pulse .75s infinite;
  }
  .warning #play{
    background:
      radial-gradient(900px 600px at 50% 40%, rgba(255,77,77,.15), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.03), transparent 25%),
      var(--bg);
  }
  @keyframes pulse{
    0%{ transform: scale(1); opacity: 1; }
    50%{ transform: scale(1.05); opacity: 0.9; }
    100%{ transform: scale(1); opacity: 1; }
  }

  .timeoutFlash #play{
    box-shadow:
      inset 0 0 0 2px rgba(255,255,255,.03),
      0 0 0 1px rgba(255,255,255,.03),
      0 0 60px rgba(255,77,77,.4);
    background-color: rgba(255,0,0,0.1);
  }

  .ripple{
    position:absolute;
    border-radius: 50%;
    background: rgba(255,255,255,.2);
    transform: scale(0);
    animation: ripple .5s ease-out;
    pointer-events:none;
  }
  @keyframes ripple{
    to { transform: scale(1.5); opacity: 0; }
  }

  #playBadge{
    position:absolute;
    top: 14px;
    right: 14px;
    font-family: var(--mono);
    font-size: 11px;
    color: rgba(255,255,255,.6);
    background: rgba(0,0,0,.4);
    border: 1px solid rgba(255,255,255,.10);
    padding: 6px 12px;
    border-radius: 999px;
    backdrop-filter: blur(4px);
    user-select:none;
    pointer-events: none;
  }

  /* ===== SETTINGS MODAL ===== */
  #settingsBackdrop{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.8);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
    z-index: 55;
    opacity: 0;
    transition: opacity 0.2s;
  }
  #settingsBackdrop.open{ display:flex; opacity: 1; }

  #settingsModal{
    width: min(780px, 100%);
    background: var(--panel);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,.6);
    overflow: hidden;
    position: relative;
    display: flex;
    flex-direction: column;
    max-height: 90vh;
  }

  #settingsHeader{
    padding: 20px 24px 16px;
    border-bottom: 1px solid rgba(255,255,255,.08);
    flex: 0 0 auto;
    background: var(--panel);
  }
  #settingsHeader h2{
    margin: 0;
    font-size: 20px;
    letter-spacing: .2px;
  }
  #settingsHeader p{
    margin: 6px 0 0;
    color: var(--muted);
    font-size: 13px;
  }

  #settingsBody{
    padding: 20px 24px 20px;
    flex: 1 1 auto;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 16px;
  }
  @media (max-width: 500px){
    .grid{ grid-template-columns: 1fr; }
  }

  .field label{
    display:block;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    margin-bottom: 8px;
  }
  .field input, .field select{
    width:100%;
    height: 52px;
    padding: 0 16px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.3);
    color: var(--text);
    outline: none;
    font-size: 16px;
    box-sizing: border-box; /* パディングを含める */
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .field input:focus, .field select:focus{
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(42,99,255,.25);
  }

  .playersGrid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid rgba(255,255,255,0.08);
  }
  @media (max-width: 500px){
    .playersGrid{ grid-template-columns: 1fr; }
  }

  .playerWrap.hidden{ display:none; }

  #settingsFooter{
    padding: 16px 24px;
    background: rgba(23,26,31,0.95);
    border-top: 1px solid rgba(255,255,255,.08);
    display:flex;
    gap: 12px;
    align-items:center;
    flex: 0 0 auto;
  }

  .btn{
    height: 56px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    color: var(--text);
    font-weight: 700;
    font-size: 16px;
    padding: 0 16px;
    cursor:pointer;
    flex: 1;
    transition: background 0.15s;
  }
  .btnPrimary{
    flex: 2;
    background: linear-gradient(180deg, rgba(42,99,255,.95), rgba(42,99,255,.75));
    border-color: rgba(42,99,255,.7);
    box-shadow: 0 4px 12px rgba(42,99,255,.3);
  }
  .btnPrimary:active{ transform: translateY(1px); }

  .btnSecondary:hover{ background: rgba(255,255,255,.1); }
  
  .btnDanger{
    background: rgba(255,77,77,.1);
    border-color: rgba(255,77,77,.3);
    color: #ff8080;
    max-width: 100px;
  }
  .btnDanger:hover{ background: rgba(255,77,77,.2); }

</style>
</head>

<body>
  <div id="home">
  <div class="home-bg"></div>
    <div class="homeCard">
      <h1 class="homeTitle">Rummikub<br>Timer</h1>
      <div class="homeActions">
        <button id="goTimer" class="homeBtn homeBtnPrimary">タップして開始</button>
      </div>
    </div>
  </div>

  <div id="play" class="theming">
    <div id="progressOuter"><div id="progressFill"></div></div>
    <div id="playBadge">Hold 3s: Settings</div>

    <div id="centerTap">
      <div id="time">0:00</div>
      <div id="playerName">-</div>
      <div id="hint">タップ: 次へ / 3回タップ: 戻る / 長押し: 設定</div>
    </div>
  </div>

  <div id="settingsBackdrop" aria-hidden="true">
    <div id="settingsModal" role="dialog" aria-modal="true">
      <div id="settingsHeader">
        <h2>設定</h2>
        <p>人数と時間を設定して開始してください。</p>
      </div>

      <div id="settingsBody">
        <div class="grid">
          <div class="field">
            <label for="count">参加人数</label>
            <select id="count">
              <option>2</option>
              <option selected>3</option>
              <option>4</option>
              <option>5</option>
            </select>
          </div>
          <div class="field">
            <label for="limit">制限時間（秒）</label>
            <input id="limit" type="number" inputmode="numeric" min="5" step="5" value="60">
          </div>
        </div>

        <div class="playersGrid" id="playersGrid">
          <div class="field playerWrap" data-player="1">
            <label>プレイヤー1</label>
            <input class="pname" value="P1" inputmode="text" />
          </div>
          <div class="field playerWrap" data-player="2">
            <label>プレイヤー2</label>
            <input class="pname" value="P2" inputmode="text" />
          </div>
          <div class="field playerWrap" data-player="3">
            <label>プレイヤー3</label>
            <input class="pname" value="P3" inputmode="text" />
          </div>
          <div class="field playerWrap" data-player="4">
            <label>プレイヤー4</label>
            <input class="pname" value="P4" inputmode="text" />
          </div>
          <div class="field playerWrap" data-player="5">
            <label>プレイヤー5</label>
            <input class="pname" value="P5" inputmode="text" />
          </div>
        </div>
      </div>

      <div id="settingsFooter">
        <button id="reset" class="btn btnDanger" type="button">リセット</button>
        <button id="close" class="btn btnSecondary" type="button">閉じる</button>
        <button id="start" class="btn btnPrimary" type="button">ゲーム開始</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // Elements
  const home = $("home");
  const goTimerBtn = $("goTimer");

  const play = $("play");
  const centerTap = $("centerTap");
  const timeEl = $("time");
  const playerNameEl = $("playerName");
  const progressFill = $("progressFill");

  const settingsBackdrop = $("settingsBackdrop");
  const countEl = $("count");
  const limitEl = $("limit");
  const startBtn = $("start");
  const resetBtn = $("reset");
  const closeBtn = $("close");
  const playerWraps = [...document.querySelectorAll(".playerWrap")];
  const nameInputs = [...document.querySelectorAll(".pname")];

  // Theme colors per player
  const THEME = ["#ff4d4d", "#2a63ff", "#ffd24d", "#57d6a3", "#b070ff"];

  // State
  let players = ["P1","P2","P3"];
  let limitSec = 60;
  let idx = 0;
  let remaining = 60;
  let timer = null;

  let playing = false;
  let timedOut = false;

  // Long press / Tap
  const HOLD_MS = 2500; // 3秒は長いので2.5秒に短縮
  let holdTimer = null;
  let holdFired = false;
  let longPressActive = false;
  
  let tapCount = 0;
  let tapWindowTimer = null;
  const TAP_WINDOW_MS = 280; // 少し短くして反応良く
  let suppressClick = false;

  // Wake Lock
  let wakeLock = null;

  // -------- Audio Singleton (Fix)
  let audioCtx = null;

  function getAudioContext() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    return audioCtx;
  }

  // ユーザー操作でオーディオコンテキストをアクティブ化
  function unlockAudio() {
    const ctx = getAudioContext();
    if (ctx.state === 'suspended') {
      ctx.resume();
    }
    // 無音バッファを再生してiOS等のロックを確実に解除
    const buffer = ctx.createBuffer(1, 1, 22050);
    const source = ctx.createBufferSource();
    source.buffer = buffer;
    source.connect(ctx.destination);
    source.start(0);
  }

  function tone(ms, freq, type="square", gain=0.05){
    try{
      const ctx = getAudioContext();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      
      o.type = type;
      o.frequency.value = freq;
      
      // クリックノイズ防止のエンベロープ
      const now = ctx.currentTime;
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(gain, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.001, now + ms/1000);

      o.connect(g); 
      g.connect(ctx.destination);
      
      o.start(now);
      o.stop(now + ms/1000 + 0.1);
      
      // GC対策: 終了後に切断
      setTimeout(() => {
        o.disconnect();
        g.disconnect();
      }, ms + 200);

    }catch(e){
      console.warn(e);
    }
  }

  // Sounds
  function clickSound(){ tone(80, 1100, "square", 0.04); }
  function backSound(){ tone(90, 740, "square", 0.04); }
  function warnTick(){ tone(50, 1400, "square", 0.03); }
  function alarmSound(){
    tone(250, 520, "sawtooth", 0.05);
    setTimeout(() => tone(250, 420, "sawtooth", 0.05), 280);
  }
  function openSound(){ tone(150, 600, "sine", 0.05); }

  // -------- Wake Lock
  async function requestWakeLock() {
    if ('wakeLock' in navigator) {
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        console.log("WakeLock active");
        wakeLock.addEventListener('release', () => {
          console.log('Wake Lock released');
        });
      } catch (err) {
        console.log(err);
      }
    }
  }

  // -------- Logic
  function format(sec){
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return `${m}:${String(s).padStart(2,"0")}`;
  }

  function setTheme(){
    const c = THEME[idx % THEME.length];
    document.documentElement.style.setProperty("--theme", c);
    document.documentElement.style.setProperty("--themeSoft", hexToRgba(c, .22));
    progressFill.style.background = `linear-gradient(90deg, ${hexToRgba(c,.90)}, ${hexToRgba(c,.35)})`;
    play.classList.add("theming");
  }

  function hexToRgba(hex, a){
    const h = hex.replace("#","");
    if(h.length !== 6) return `rgba(100,100,100,${a})`;
    const r = parseInt(h.substring(0,2),16);
    const g = parseInt(h.substring(2,4),16);
    const b = parseInt(h.substring(4,6),16);
    return `rgba(${r},${g},${b},${a})`;
  }

  // Screens
  function showHome(){
    home.classList.remove("hidden");
    playing = false;
    stopTimer();
    closeSettings(true);
  }

  function hideHome(){
    home.classList.add("hidden");
  }

  function openSettings(){
    stopTimer();
    playing = false;
    setWarning(false);
    settingsBackdrop.classList.add("open");
    settingsBackdrop.setAttribute("aria-hidden","false");
    // 設定画面を開いたときにもWakeLock再試行
    requestWakeLock();
  }

  function closeSettings(force=false){
    settingsBackdrop.classList.remove("open");
    settingsBackdrop.setAttribute("aria-hidden","true");
  }

  function applyPlayerVisibility(){
    const n = Number(countEl.value);
    playerWraps.forEach(w => {
      const p = Number(w.dataset.player);
      w.classList.toggle("hidden", p > n);
    });
  }

  // Timer
  function startTurn(){
    remaining = limitSec;
    timedOut = false;
    setWarning(false);
    updateUI();
    stopTimer();
    timer = setInterval(tick, 1000);
  }

  function stopTimer(){
    if(timer) clearInterval(timer);
    timer = null;
  }

  function tick(){
    if(!playing) return;

    if(remaining <= 10 && remaining > 0){
      warnTick();
      setWarning(true);
    }else{
      setWarning(false);
    }

    remaining = Math.max(0, remaining - 1);
    updateUI();

    if(remaining === 0){
      stopTimer();
      timedOut = true;
      alarmSound();
      flashTimeout();
    }
  }

  function updateUI(){
    timeEl.textContent = format(remaining);
    playerNameEl.textContent = `${players[idx] ?? "-"}`;
    setTheme();

    const pct = limitSec > 0 ? (remaining / limitSec) * 100 : 0;
    progressFill.style.width = `${pct}%`;
  }

  function setWarning(on){
    document.body.classList.toggle("warning", on);
  }

  function flashTimeout(){
    document.body.classList.add("timeoutFlash");
    setTimeout(() => document.body.classList.remove("timeoutFlash"), 400);
  }

  function nextPlayer(){
    if(!playing) return;
    idx = (idx + 1) % players.length;
    clickSound();
    startTurn();
  }

  function prevPlayer(){
    if(!playing) return;
    idx = (idx - 1 + players.length) % players.length;
    backSound();
    startTurn();
  }

  // Visual Effect
  function rippleAt(x, y){
    const r = document.createElement("div");
    r.className = "ripple";
    // 画面サイズ基準で大きさを決める
    const size = Math.max(window.innerWidth, window.innerHeight);
    r.style.width = r.style.height = `${size}px`;
    r.style.left = `${x - size/2}px`;
    r.style.top  = `${y - size/2}px`;
    play.appendChild(r);
    r.addEventListener("animationend", () => r.remove());
  }

  // Tap Dispatcher
  function scheduleTapAction(){
    if(tapWindowTimer) return;
    tapWindowTimer = setTimeout(() => {
      const c = tapCount;
      tapCount = 0;
      tapWindowTimer = null;

      if(holdFired) return;

      if(c >= 3){
        prevPlayer();
      }else{
        nextPlayer();
      }
    }, TAP_WINDOW_MS);
  }

  // Events
  countEl.addEventListener("change", applyPlayerVisibility);

  goTimerBtn.addEventListener("click", () => {
    // 最初のインタラクションでオーディオ許可
    unlockAudio();
    hideHome();
    openSettings();
  });

  startBtn.addEventListener("click", () => {
    unlockAudio();
    requestWakeLock(); // 常時点灯要求

    const n = Number(countEl.value);
    players = nameInputs.slice(0, n).map((inp, i) => (inp.value || `P${i+1}`).trim());
    limitSec = Math.max(5, Number(limitEl.value || 60));
    idx = 0;

    playing = true;
    closeSettings();
    startTurn();
  });

  resetBtn.addEventListener("click", () => {
    countEl.value = "3";
    limitEl.value = "60";
    nameInputs.forEach((inp, i) => inp.value = `P${i+1}`);
    applyPlayerVisibility();
    backSound();
  });

  closeBtn.addEventListener("click", () => {
    if(playing){
      closeSettings();
    }else{
      closeSettings(true);
      showHome();
    }
  });

  // Tap / Hold Logic
  centerTap.addEventListener("pointerdown", (e) => {
    if (!playing) return;

    // 即座に視覚フィードバック（これがスムーズさの鍵）
    rippleAt(e.clientX, e.clientY);

    longPressActive = false;
    suppressClick = false;
    holdFired = false;

    holdTimer = setTimeout(() => {
      longPressActive = true;
      suppressClick = true;
      holdFired = true;
      openSettings();
      openSound();
    }, HOLD_MS);
  });

  const clearHold = () => {
    if (holdTimer) clearTimeout(holdTimer);
    holdTimer = null;
  };

  ["pointerup","pointercancel","pointerleave"].forEach(ev => {
    centerTap.addEventListener(ev, clearHold);
  });

  centerTap.addEventListener("click", () => {
    if (!playing) return;
    if (longPressActive || suppressClick) return;
    tapCount += 1;
    scheduleTapAction();
  });

  // Visibility Change (WakeLock再取得)
  document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
      await requestWakeLock();
    }
    // オーディオコンテキストの再開
    if (audioCtx && audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
  });

  // Init
  applyPlayerVisibility();
  showHome();
  updateUI();
})();
</script>
</body>
</html>
